import time
import unittest

import pandas
from bs4 import BeautifulSoup

from natcap.invest.coastal_vulnerability import MODEL_SPEC
from natcap.invest.reports import jinja_env


class CoastalVulnerabilityReportTests(unittest.TestCase):
    """Unit tests for Coastal Vulnerability template."""

    def test_template_render(self):
        """Test render the coastal vulnerability template."""
        template = jinja_env.get_template('models/coastal_vulnerability.html')

        vegalite_json = '{}'
        caption = 'figure caption'
        source_list = ['a', 'b']
        args_dict = {}
        exposure_map_json = vegalite_json
        habitat_map_json = vegalite_json
        habitat_params_df = pandas.DataFrame()
        exposure_histogram_json = vegalite_json
        facetted_histograms_json = vegalite_json
        rank_vars_figure_json = vegalite_json
        wave_energy_map_json = vegalite_json
        html = template.render(
            report_script=__file__,
            timestamp=time.strftime('%Y-%m-%d %H:%M'),
            model_id=MODEL_SPEC.model_id,
            model_name=MODEL_SPEC.model_title,
            model_description=MODEL_SPEC.about,
            userguide_page=MODEL_SPEC.userguide,
            args_dict=args_dict,
            exposure_map_json=exposure_map_json,
            exposure_map_caption=caption,
            exposure_map_source_list=source_list,
            habitat_map_json=habitat_map_json,
            habitat_map_caption=caption,
            habitat_map_source_list=source_list,
            habitat_params_table=habitat_params_df.to_html(),
            habitat_table_caption=caption,
            habitat_table_source_list=source_list,
            exposure_histogram_json=exposure_histogram_json,
            facetted_histograms_json=facetted_histograms_json,
            facetted_histograms_caption=caption,
            facetted_histograms_source_list=source_list,
            rank_vars_figure_json=rank_vars_figure_json,
            rank_vars_figure_caption=caption,
            rank_vars_figure_source_list=source_list,
            wave_energy_map_json=wave_energy_map_json,
            wave_energy_map_caption=caption,
            wave_energy_map_source_list=source_list,
            model_spec_outputs=MODEL_SPEC.outputs,
        )

        soup = BeautifulSoup(html, 'html.parser')
        self.assertEqual(
            soup.title.string, f'InVEST Results: {MODEL_SPEC.model_title}')
        sections = soup.find_all('section')
        self.assertEqual(len(sections), 6)
